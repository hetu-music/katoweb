# 封面上传功能使用指南

## 功能概述

在admin页面的歌曲管理中，当选择"定制封面"选项时，会出现文件上传界面，允许管理员上传JPG格式的封面图片。

## 功能特性

- ✅ 只允许上传JPG格式的图片文件
- ✅ 文件大小限制为5MB
- ✅ 自动重命名为`歌曲ID.jpg`格式
- ✅ 上传到指定的封面服务器地址
- ✅ 实时上传状态反馈
- ✅ 错误处理和用户提示

## 使用步骤

1. **进入admin页面**
   - 登录管理员账户
   - 进入歌曲管理页面

2. **编辑或新增歌曲**
   - 点击"编辑"按钮编辑现有歌曲，或点击"新增歌曲"
   - 在表单中找到"封面"字段

3. **选择定制封面**
   - 在封面下拉菜单中选择"定制封面"
   - 此时会显示文件上传区域

4. **上传封面文件**
   - 点击"选择JPG文件"按钮
   - 选择符合要求的JPG图片文件
   - 系统会自动验证文件格式和大小
   - 上传成功后会显示确认消息

## 文件要求

- **格式**: 只支持JPG/JPEG格式
- **大小**: 不超过5MB
- **命名**: 上传后自动重命名为`{歌曲ID}.jpg`

## 存储位置

上传的封面文件会保存到：
```
https://cover.hetu-music.com/cover/{歌曲ID}.jpg
```

## 环境配置

在`.env.local`文件中可以配置以下参数：

```env
# 封面上传配置
COVER_UPLOAD_DIR=public/covers          # 本地存储目录
COVER_BASE_URL=https://cover.hetu-music.com/cover  # 封面访问基础URL
```

## 技术实现

### 新增文件

1. **API路由**: `src/app/api/admin/upload-cover/route.ts`
   - 处理文件上传请求
   - 验证用户权限和CSRF令牌
   - 文件格式和大小验证

2. **上传工具**: `src/app/lib/upload.ts`
   - 文件上传核心逻辑
   - 配置管理
   - 文件验证工具

3. **上传组件**: `src/app/admin/components/CoverUpload.tsx`
   - 文件选择界面
   - 上传进度显示
   - 状态反馈

### 修改文件

1. **AdminClient组件**: `src/app/admin/components/AdminClient.tsx`
   - 在`renderInput`函数中添加封面上传逻辑
   - 当选择"定制封面"时显示上传组件

## 注意事项

1. **权限要求**: 只有登录的管理员用户才能上传封面
2. **CSRF保护**: 所有上传请求都需要有效的CSRF令牌
3. **文件存储**: 当前实现使用本地文件系统，生产环境建议使用云存储服务
4. **歌曲ID**: 必须先保存歌曲获得ID后才能上传封面

## 扩展建议

1. **云存储集成**: 可以集成AWS S3、阿里云OSS等云存储服务
2. **图片处理**: 可以添加图片压缩、裁剪等处理功能
3. **批量上传**: 支持批量上传多个封面
4. **预览功能**: 添加封面预览功能
5. **版本管理**: 支持封面版本历史管理

## 故障排除

### 常见问题

1. **上传失败**
   - 检查文件格式是否为JPG
   - 检查文件大小是否超过5MB
   - 确认网络连接正常

2. **权限错误**
   - 确认已正确登录管理员账户
   - 检查CSRF令牌是否有效

3. **文件不显示**
   - 检查封面URL是否正确
   - 确认服务器文件存储配置

### 日志查看

服务器端错误会记录在控制台中，可以通过以下方式查看：
```bash
# 开发环境
npm run dev

# 生产环境
npm run start
```

## 更新日志

- **v1.0.0**: 初始版本，支持基本的JPG封面上传功能